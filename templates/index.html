<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Ethereum Wallet DeFi Score - Calculate your DeFi Strategy Score for any Ethereum wallet. Analyze transaction count, protocol interactions, asset holdings, and DeFi engagement using real-time blockchain data from Bitquery."
    />
    <meta
      name="keywords"
      content="Ethereum wallet DeFi score, DeFi strategy score calculator, Ethereum wallet analyzer, DeFi score, wallet DeFi analysis, blockchain analytics, DeFi engagement score, on-chain analysis"
    />
    <meta name="author" content="Ethereum Wallet DeFi Score" />
    <title>
      Ethereum Wallet DeFi Score - Calculate Your DeFi Strategy Score
    </title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="Ethereum Wallet DeFi Score - Calculate Your DeFi Strategy Score"
    />
    <meta
      property="og:description"
      content="Calculate your DeFi Strategy Score for any Ethereum wallet. Analyze transaction patterns, protocol interactions, and asset holdings using real-time blockchain data."
    />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta
      property="twitter:title"
      content="Ethereum Wallet DeFi Score - Calculate Your DeFi Strategy Score"
    />
    <meta
      property="twitter:description"
      content="Calculate your DeFi Strategy Score for any Ethereum wallet. Analyze transaction patterns, protocol interactions, and asset holdings using real-time blockchain data."
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        color: #1a1a1a;
        background: #fafafa;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      header {
        background: #fff;
        border-bottom: 1px solid #e5e5e5;
        padding: 24px 0;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      header h1 {
        font-size: 24px;
        font-weight: 600;
        color: #1a1a1a;
      }

      .hero {
        padding: 60px 0;
        text-align: center;
      }

      .hero h2 {
        font-size: 42px;
        font-weight: 700;
        margin-bottom: 16px;
        color: #1a1a1a;
      }

      .hero p {
        font-size: 18px;
        color: #666;
        max-width: 600px;
        margin: 0 auto 40px;
      }

      .search-box {
        max-width: 600px;
        margin: 0 auto 60px;
      }

      .search-form {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
      }

      .search-input {
        flex: 1;
        padding: 14px 18px;
        font-size: 16px;
        border: 2px solid #e5e5e5;
        border-radius: 8px;
        transition: border-color 0.2s;
      }

      .search-input:focus {
        outline: none;
        border-color: #0066ff;
      }

      .search-btn {
        padding: 14px 32px;
        font-size: 16px;
        font-weight: 500;
        background: #0066ff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .search-btn:hover {
        background: #0052cc;
      }

      .search-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .error-message {
        background: #fee;
        color: #c33;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: none;
      }

      .results {
        display: none;
        background: white;
        border-radius: 12px;
        padding: 40px;
        margin-bottom: 60px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .score-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .final-score {
        font-size: 64px;
        font-weight: 700;
        color: #0066ff;
        margin: 20px 0;
      }

      .score-label {
        font-size: 32px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 8px;
      }

      .pillars {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 24px;
        margin-bottom: 40px;
      }

      .pillar-card {
        background: #f8f9fa;
        padding: 24px;
        border-radius: 8px;
      }

      .pillar-title {
        font-size: 14px;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .pillar-title-text {
        flex: 1;
      }

      .get-api-btn {
        font-size: 11px;
        font-weight: 500;
        padding: 4px 10px;
        background: #0066ff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.2s;
        text-transform: none;
        letter-spacing: 0;
      }

      .get-api-btn:hover {
        background: #0052cc;
      }

      .info-section .get-api-btn {
        font-size: 12px;
        padding: 5px 12px;
        margin-left: 8px;
      }

      .pillar-score {
        font-size: 32px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 4px;
      }

      .pillar-detail {
        font-size: 14px;
        color: #666;
      }

      .info-section {
        background: white;
        border-radius: 12px;
        padding: 40px;
        margin-bottom: 40px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .info-section h3 {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 24px;
        color: #1a1a1a;
      }

      .info-section p {
        color: #666;
        margin-bottom: 16px;
        line-height: 1.8;
      }

      .info-section ul {
        list-style: none;
        padding-left: 0;
      }

      .info-section li {
        padding: 12px 0;
        border-bottom: 1px solid #e5e5e5;
      }

      .info-section li:last-child {
        border-bottom: none;
      }

      .info-section strong {
        color: #1a1a1a;
        display: block;
        margin-bottom: 4px;
      }

      .faq-item {
        margin-bottom: 24px;
      }

      .faq-question {
        font-size: 18px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 8px;
      }

      .faq-answer {
        color: #666;
        line-height: 1.8;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #0066ff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      footer {
        background: #1a1a1a;
        color: #999;
        padding: 40px 0;
        margin-top: 80px;
      }

      footer p {
        text-align: center;
        font-size: 14px;
      }

      .data-source {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 24px;
        border-left: 4px solid #0066ff;
      }

      .data-source p {
        margin: 0;
        font-size: 14px;
        color: #666;
      }

      .recent-section {
        background: white;
        border-radius: 12px;
        padding: 40px;
        margin-bottom: 40px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .recent-section h3 {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 24px;
        color: #1a1a1a;
      }

      .recent-table {
        width: 100%;
        border-collapse: collapse;
      }

      .recent-table thead {
        border-bottom: 2px solid #e5e5e5;
      }

      .recent-table th {
        text-align: left;
        padding: 12px 16px;
        font-size: 12px;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .recent-table th.final-score-header {
        font-size: 14px;
        color: #1a1a1a;
      }

      .recent-table td {
        padding: 16px;
        font-size: 15px;
        color: #1a1a1a;
      }

      .recent-table tbody tr {
        border-bottom: 1px solid #f0f0f0;
      }

      .recent-table tbody tr:last-child {
        border-bottom: none;
      }

      .recent-table tbody tr:hover {
        background: #f8f9fa;
      }

      .address-link {
        color: #0066ff;
        text-decoration: none;
        font-family: "Courier New", monospace;
        font-size: 14px;
      }

      .address-link:hover {
        text-decoration: underline;
      }

      .score-cell {
        font-weight: 600;
        color: #1a1a1a;
      }

      .final-score-cell {
        font-weight: 700;
        font-size: 18px;
        color: #1a1a1a;
      }

      .empty-recent {
        text-align: center;
        padding: 40px;
        color: #999;
        font-style: italic;
      }

      .checks-counter {
        text-align: center;
        font-size: 14px;
        color: #666;
        margin-top: 8px;
        font-weight: 500;
      }

      .checks-counter.zero {
        color: #c33;
      }

      /* Modal Styles */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      .modal-overlay.show {
        display: flex;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal {
        background: white;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
        position: relative;
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: #f0f0f0;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #666;
        transition: all 0.2s;
        z-index: 10;
      }

      .modal-close:hover {
        background: #e0e0e0;
        color: #1a1a1a;
      }

      .modal-content {
        padding: 40px;
      }

      .modal-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        font-size: 32px;
      }

      .modal-title {
        font-size: 28px;
        font-weight: 700;
        color: #1a1a1a;
        text-align: center;
        margin-bottom: 12px;
      }

      .modal-description {
        font-size: 16px;
        color: #666;
        text-align: center;
        line-height: 1.6;
        margin-bottom: 32px;
      }

      .modal-features {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 32px;
      }

      .modal-features-title {
        font-size: 16px;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 16px;
      }

      .modal-features-list {
        list-style: none;
        padding: 0;
      }

      .modal-features-list li {
        padding: 8px 0;
        color: #666;
        font-size: 14px;
        display: flex;
        align-items: center;
      }

      .modal-features-list li:before {
        content: "âœ“";
        color: #0066ff;
        font-weight: bold;
        margin-right: 12px;
        font-size: 18px;
      }

      .modal-button {
        width: 100%;
        padding: 16px 32px;
        font-size: 16px;
        font-weight: 600;
        background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: block;
        text-align: center;
      }

      .modal-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 102, 255, 0.3);
      }

      .modal-button:active {
        transform: translateY(0);
      }

      @media (max-width: 768px) {
        .hero h2 {
          font-size: 32px;
        }

        .search-form {
          flex-direction: column;
        }

        .pillars {
          grid-template-columns: 1fr;
        }

        .final-score {
          font-size: 48px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <h1>Ethereum Wallet DeFi Score</h1>
      </div>
    </header>

    <main>
      <section class="hero">
        <div class="container">
          <h2>Analyze Ethereum Wallet DeFi Activity</h2>
          <p>
            Calculate the DeFi Strategy Score for any Ethereum address by
            analyzing transaction patterns, protocol interactions, and asset
            holdings. Get insights into wallet engagement with decentralized
            finance protocols.
          </p>

          <div class="search-box">
            <form class="search-form" id="searchForm">
              <input
                type="text"
                class="search-input"
                id="addressInput"
                placeholder="Enter Ethereum address (0x...)"
                required
                pattern="^0x[a-fA-F0-9]{40}$"
              />
              <button type="submit" class="search-btn" id="searchBtn">
                Analyze
              </button>
            </form>
            <div class="error-message" id="errorMessage"></div>
            <div class="checks-counter" id="checksCounter">
              3/3 checks available
            </div>

            <div class="loading" id="loading">
              <div class="spinner"></div>
              <p>Analyzing wallet activity... This may take a minute or two.</p>
            </div>
          </div>
        </div>
      </section>

      <div class="container">
        <div class="recent-section">
          <h3>Recent 5 Wallets Analyzed</h3>
          <div id="recentWallets">
            <div class="empty-recent">
              No wallets analyzed yet. Be the first!
            </div>
          </div>
        </div>

        <div class="results" id="results">
          <div class="score-header">
            <div class="score-label">Final Score</div>
            <div class="final-score" id="finalScore">-</div>
            <div style="color: #666; font-size: 14px" id="addressDisplay"></div>
          </div>

          <div class="pillars" id="pillars"></div>
        </div>

        <div class="info-section">
          <h3>Understanding the DeFi Strategy Score</h3>
          <p>
            The DeFi Strategy Score measures a wallet's strategic engagement and
            sophistication within the DeFi ecosystem, independent of total
            capital deployed. The score ranges from 25 to 100, calculated using
            four key components:
          </p>

          <ul style="margin-top: 24px">
            <li>
              <strong>
                Transaction Count Score
                <a
                  href="https://ide.bitquery.io/v1-query---transaction-count-for-an-address-last-3-yrs?utm_source=ethereum-wallet-defi-score&utm_medium=web&utm_campaign=defi-score-tool"
                  target="_blank"
                  class="get-api-btn"
                  >Get API</a
                >
              </strong>
              Measures the wallet's overall activity level. Scores are based on
              the total number of successful transactions in the past 3 years,
              with 100+ transactions achieving the maximum score.
            </li>
            <li>
              <strong>
                Transaction Types Score
                <a
                  href="https://ide.bitquery.io/v1-query---Calls-to-Different-types-of-protocols-for-last-3-yrs?utm_source=ethereum-wallet-defi-score&utm_medium=web&utm_campaign=defi-score-tool"
                  target="_blank"
                  class="get-api-btn"
                  >Get API</a
                >
                <a
                  href="https://ide.bitquery.io/Get-DEX-swaps-and-NFT-trading-activity-using-v2-API?utm_source=ethereum-wallet-defi-score&utm_medium=web&utm_campaign=defi-score-tool"
                  target="_blank"
                  class="get-api-btn"
                  style="margin-left: 4px"
                  >DEX/NFT API</a
                >
              </strong>
              Evaluates the diversity of DeFi interactions. We track activity
              types: ERC-20 Trading, Lending/Borrowing, Staking, Liquidity
              Provision, NFT Trading, Bridging, and Yield Farming. Engaging with
              5+ unique types achieves the maximum score.
            </li>
            <li>
              <strong>
                Protocols Used Score
                <a
                  href="https://ide.bitquery.io/v1-query---Calls-to-Different-types-of-protocols-for-last-3-yrs?utm_source=ethereum-wallet-defi-score&utm_medium=web&utm_campaign=defi-score-tool"
                  target="_blank"
                  class="get-api-btn"
                  >Get API</a
                >
              </strong>
              Assesses how widely the wallet has interacted with the DeFi
              ecosystem. We monitor interactions with major protocols including
              Uniswap, Aave, Lido, Compound, and others. Using 8+ unique
              protocols achieves the maximum score.
            </li>
            <li>
              <strong>
                Assets Held Score
                <a
                  href="https://ide.bitquery.io/Token-balances-of-an-address-above-10_1?utm_source=ethereum-wallet-defi-score&utm_medium=web&utm_campaign=defi-score-tool"
                  target="_blank"
                  class="get-api-btn"
                  >ERC-20 API</a
                >
                <a
                  href="https://ide.bitquery.io/NFT-balances-of-an-address_1?utm_source=ethereum-wallet-defi-score&utm_medium=web&utm_campaign=defi-score-tool"
                  target="_blank"
                  class="get-api-btn"
                  style="margin-left: 4px"
                  >NFT API</a
                >
              </strong>
              Measures the diversity of the portfolio. We count ERC-20 tokens
              with balances exceeding $10 USD and individual NFT holdings.
              Holding 15+ unique assets achieves the maximum score.
            </li>
          </ul>

          <div class="data-source">
            <p>
              <strong>Data Source:</strong> All analysis is performed using
              real-time blockchain data from Bitquery, a leading blockchain data
              analytics platform. We query Ethereum mainnet transactions, smart
              contract interactions, token balances, and NFT holdings to
              calculate the score.
            </p>
          </div>
        </div>

        <div class="info-section">
          <h3>Frequently Asked Questions</h3>

          <div class="faq-item">
            <div class="faq-question">
              How is the DeFi Strategy Score calculated?
            </div>
            <div class="faq-answer">
              The score uses a base of 25 points plus a weighted average of four
              component scores. Each component is scored from 0-100 points based
              on specific metrics. The average component score is multiplied by
              0.75 and added to the base score of 25, resulting in a final score
              between 25 and 100.
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question">
              What time period does the analysis cover?
            </div>
            <div class="faq-answer">
              The analysis examines the wallet's activity over the past 1 year.
              This includes all successful transactions, protocol interactions,
              and current asset holdings as of the analysis date.
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question">Where does the data come from?</div>
            <div class="faq-answer">
              All data is sourced from Bitquery's GraphQL API, which provides
              real-time access to Ethereum blockchain data. Bitquery aggregates
              and indexes blockchain data, allowing us to query transaction
              history, smart contract interactions, token balances, and NFT
              holdings efficiently.
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question">Which protocols are tracked?</div>
            <div class="faq-answer">
              We track interactions with major DeFi protocols including Aave (v2
              and v3), Compound (v2 and v3), Uniswap V3, Lido, RocketPool, Yearn
              Finance, Convex Finance, Sparklend, Morpho, and others. The
              complete list includes over 50 protocol contract addresses across
              lending, staking, liquidity provision, bridging, and yield farming
              categories.
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question">
              Are wallet addresses stored or tracked?
            </div>
            <div class="faq-answer">
              No. We do not store, track, or log any wallet addresses. All
              analysis is performed in real-time using publicly available
              blockchain data. Privacy is maintained as we only query on-chain
              information that is already publicly accessible.
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question">
              Why might my score be lower than expected?
            </div>
            <div class="faq-answer">
              The score focuses on strategic engagement rather than capital
              deployed. A lower score might indicate limited protocol diversity,
              fewer transaction types, or a shorter activity history. The score
              is designed to measure sophistication and engagement patterns, not
              wealth or total value locked.
            </div>
          </div>

          <div class="faq-item">
            <div class="faq-question">
              How often can I check a wallet's score?
            </div>
            <div class="faq-answer">
              The score updates in real-time with each analysis. As a wallet
              engages with more DeFi protocols, diversifies transaction types,
              and expands asset holdings, the score will reflect these changes.
              You can analyze any wallet address to see its current score.
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="container">
        <p>Ethereum Wallet DeFi Score - Powered by Bitquery Blockchain Data</p>
        <p style="margin-top: 8px; font-size: 12px">
          Analyzing Ethereum wallet activity and DeFi engagement patterns
        </p>
      </div>
    </footer>

    <!-- Bitquery Signup Modal -->
    <div class="modal-overlay" id="signupModal">
      <div class="modal">
        <button class="modal-close" id="modalClose" aria-label="Close modal">
          Ã—
        </button>
        <div class="modal-content">
          <div class="modal-icon">ðŸš€</div>
          <h2 class="modal-title">Unlock Unlimited Analysis</h2>
          <p class="modal-description">
            You've used all 3 free checks! Sign up for Bitquery IDE to access
            powerful blockchain data APIs across 20+ chains and continue
            analyzing wallets.
          </p>
          <div class="modal-features">
            <div class="modal-features-title">What you'll get:</div>
            <ul class="modal-features-list">
              <li>Access to 20+ blockchain networks</li>
              <li>Real-time blockchain data APIs</li>
              <li>Advanced query capabilities</li>
              <li>Comprehensive analytics tools</li>
            </ul>
          </div>
          <a
            href="https://account.bitquery.io/auth/signup?redirect_to=https%3A%2F%2Fide.bitquery.io%2F&utm_source=ethereum-wallet-defi-score&utm_medium=web&utm_campaign=defi-score-tool"
            target="_blank"
            class="modal-button"
            id="signupButton"
          >
            Sign Up on Bitquery IDE
          </a>
        </div>
      </div>
    </div>

    <script>
      // Application root for subpath deployment
      const APPLICATION_ROOT = "{{ application_root|safe }}" || "";

      // Helper function to build API URLs
      function getApiUrl(path) {
        // Remove leading slash from path if present
        const cleanPath = path.startsWith("/") ? path.slice(1) : path;
        // Handle APPLICATION_ROOT - remove trailing slash if present
        let cleanRoot = APPLICATION_ROOT;
        if (cleanRoot && cleanRoot.endsWith("/")) {
          cleanRoot = cleanRoot.slice(0, -1);
        }
        // Build URL - if APPLICATION_ROOT is empty or just "/", use absolute path
        if (!cleanRoot || cleanRoot === "/") {
          return `/${cleanPath}`;
        }
        return `${cleanRoot}/${cleanPath}`;
      }

      const form = document.getElementById("searchForm");
      const addressInput = document.getElementById("addressInput");
      const searchBtn = document.getElementById("searchBtn");
      const errorMessage = document.getElementById("errorMessage");
      const loading = document.getElementById("loading");
      const results = document.getElementById("results");
      const recentWalletsDiv = document.getElementById("recentWallets");
      const checksCounter = document.getElementById("checksCounter");
      const signupModal = document.getElementById("signupModal");
      const modalClose = document.getElementById("modalClose");

      // Check limit management
      const MAX_CHECKS = 3;
      const STORAGE_KEY = "defi_checks_remaining";
      const UNLIMITED_KEY = "defi_checks_unlimited";

      // Check if user has unlimited checks
      function hasUnlimitedChecks() {
        return localStorage.getItem(UNLIMITED_KEY) === "true";
      }

      // Grant unlimited checks
      function grantUnlimitedChecks() {
        localStorage.setItem(UNLIMITED_KEY, "true");
        updateChecksDisplay("unlimited");
      }

      // Initialize checks on page load
      function initializeChecks() {
        if (hasUnlimitedChecks()) {
          updateChecksDisplay("unlimited");
          return;
        }

        const remaining = localStorage.getItem(STORAGE_KEY);
        if (remaining === null) {
          localStorage.setItem(STORAGE_KEY, MAX_CHECKS.toString());
          updateChecksDisplay(MAX_CHECKS);
        } else {
          const count = parseInt(remaining, 10);
          updateChecksDisplay(count);
        }
      }

      function getRemainingChecks() {
        if (hasUnlimitedChecks()) {
          return Infinity; // Return Infinity to indicate unlimited
        }
        const remaining = localStorage.getItem(STORAGE_KEY);
        return remaining !== null ? parseInt(remaining, 10) : MAX_CHECKS;
      }

      function decrementChecks() {
        // Don't decrement if unlimited
        if (hasUnlimitedChecks()) {
          return;
        }

        const current = getRemainingChecks();
        if (current > 0 && current !== Infinity) {
          const newCount = current - 1;
          localStorage.setItem(STORAGE_KEY, newCount.toString());
          updateChecksDisplay(newCount);
        }
      }

      function updateChecksDisplay(count) {
        if (count === "unlimited" || count === Infinity) {
          // Hide counter when unlimited
          checksCounter.style.display = "none";
        } else {
          checksCounter.style.display = "block";
          if (count <= 0) {
            checksCounter.textContent = "0/3 checks available";
            checksCounter.classList.add("zero");
          } else {
            checksCounter.textContent = `${count}/3 checks available`;
            checksCounter.classList.remove("zero");
          }
        }
      }

      function showSignupModal() {
        signupModal.classList.add("show");
        document.body.style.overflow = "hidden";
      }

      function hideSignupModal() {
        signupModal.classList.remove("show");
        document.body.style.overflow = "";
      }

      // Modal event listeners
      modalClose.addEventListener("click", hideSignupModal);
      signupModal.addEventListener("click", (e) => {
        if (e.target === signupModal) {
          hideSignupModal();
        }
      });

      // Close modal on Escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && signupModal.classList.contains("show")) {
          hideSignupModal();
        }
      });

      // Signup button click handler - grant unlimited checks
      const signupButton = document.getElementById("signupButton");
      signupButton.addEventListener("click", () => {
        grantUnlimitedChecks();
        hideSignupModal();
      });

      // Initialize checks counter
      initializeChecks();

      // Load recent wallets on page load
      loadRecentWallets();

      async function loadRecentWallets() {
        try {
          const url = getApiUrl("api/recent");
          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            const text = await response.text();
            throw new Error("Server returned non-JSON response");
          }

          const data = await response.json();

          if (data.success && data.data.length > 0) {
            displayRecentWallets(data.data);
          }
        } catch (error) {
          // Silently handle error loading recent wallets
        }
      }

      function displayRecentWallets(wallets) {
        if (wallets.length === 0) {
          recentWalletsDiv.innerHTML =
            '<div class="empty-recent">No wallets analyzed yet. Be the first!</div>';
          return;
        }

        let tableHTML = '<table class="recent-table"><thead><tr>';
        tableHTML += "<th>Address</th>";
        tableHTML += "<th>Transaction Count Score</th>";
        tableHTML += "<th>Transaction Types Score</th>";
        tableHTML += "<th>Protocols Used Score</th>";
        tableHTML += "<th>Assets Held Score</th>";
        tableHTML += '<th class="final-score-header">Final Score</th>';
        tableHTML += "</tr></thead><tbody>";

        wallets.forEach((wallet) => {
          const explorerUrl = `https://explorer.bitquery.io/ethereum/address/${wallet.address}?utm_source=ethereum-wallet-defi-score&utm_medium=web&utm_campaign=defi-score-tool`;
          const shortAddress =
            wallet.address.substring(0, 6) +
            "..." +
            wallet.address.substring(38);

          tableHTML += "<tr>";
          tableHTML += `<td><a href="${explorerUrl}" target="_blank" class="address-link" title="${wallet.address}">${shortAddress}</a></td>`;
          tableHTML += `<td class="score-cell">${wallet.p1.toFixed(2)}</td>`;
          tableHTML += `<td class="score-cell">${wallet.p2.toFixed(2)}</td>`;
          tableHTML += `<td class="score-cell">${wallet.p3.toFixed(2)}</td>`;
          tableHTML += `<td class="score-cell">${wallet.p4.toFixed(2)}</td>`;
          tableHTML += `<td class="final-score-cell">${wallet.final_score}</td>`;
          tableHTML += "</tr>";
        });

        tableHTML += "</tbody></table>";
        recentWalletsDiv.innerHTML = tableHTML;
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const address = addressInput.value.trim();

        // Check if user has remaining checks (show modal every time if no checks and not unlimited)
        const remaining = getRemainingChecks();
        if (remaining <= 0 && !hasUnlimitedChecks()) {
          showSignupModal();
          return;
        }

        // Validate address
        if (!address.startsWith("0x") || address.length !== 42) {
          showError(
            "Please enter a valid Ethereum address (0x followed by 40 hexadecimal characters)"
          );
          return;
        }

        // Reset UI
        errorMessage.style.display = "none";
        results.style.display = "none";
        loading.style.display = "block";
        searchBtn.disabled = true;

        try {
          const url = getApiUrl("api/calculate");
          const response = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ address: address }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            const text = await response.text();
            throw new Error(
              "Server returned non-JSON response. Check if the API endpoint is correct."
            );
          }

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "An error occurred");
          }

          // Decrement checks only on successful analysis
          decrementChecks();

          displayResults(data.data);

          // Refresh recent wallets after successful calculation
          loadRecentWallets();
        } catch (error) {
          showError(
            error.message || "Failed to analyze address. Please try again."
          );
        } finally {
          loading.style.display = "none";
          searchBtn.disabled = false;
        }
      });

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
      }

      function displayResults(data) {
        document.getElementById("finalScore").textContent =
          data.final_score_rounded;
        document.getElementById("addressDisplay").textContent = data.address;

        const pillarsDiv = document.getElementById("pillars");
        pillarsDiv.innerHTML = `
                <div class="pillar-card">
                    <div class="pillar-title">
                      <span class="pillar-title-text">Transaction Count Score</span>
                    </div>
                    <div class="pillar-score">${data.p1.score.toFixed(2)}</div>
                    <div class="pillar-detail">${
                      data.p1.tx_count
                    } transactions</div>
                </div>
                <div class="pillar-card">
                    <div class="pillar-title">
                      <span class="pillar-title-text">Transaction Types Score</span>
                    </div>
                    <div class="pillar-score">${data.p2.score.toFixed(2)}</div>
                    <div class="pillar-detail">${
                      data.p2.unique_types
                    } unique types</div>
                </div>
                <div class="pillar-card">
                    <div class="pillar-title">
                      <span class="pillar-title-text">Protocols Used Score</span>
                    </div>
                    <div class="pillar-score">${data.p3.score.toFixed(2)}</div>
                    <div class="pillar-detail">${
                      data.p3.unique_protocols
                    } protocols</div>
                </div>
                <div class="pillar-card">
                    <div class="pillar-title">
                      <span class="pillar-title-text">Assets Held Score</span>
                    </div>
                    <div class="pillar-score">${data.p4.score.toFixed(2)}</div>
                    <div class="pillar-detail">${
                      data.p4.unique_assets
                    } assets</div>
                </div>
            `;

        results.style.display = "block";
        results.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    </script>
  </body>
</html>
